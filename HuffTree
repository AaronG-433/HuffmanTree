import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.util.HashMap;
import java.util.Iterator;
import java.util.Map;

public class HuffTree implements HuffmanCoding
{
    private HuffNode root;
    private HashMap<Character, String> map = new HashMap<>();

    /** Constructors */
    HuffTree()          //default constructor
    {root = null; }

    HuffTree(char let, int wt)           //leaf constructor
    { root = new HuffNode(let, wt); }

    HuffTree(HuffNode l, HuffNode r, int wt)        //internal node constructor
    { root = new HuffNode(l, r, wt); }

    //returns root
    HuffNode getRoot()
    { return root; }

    //returns weight
    public int getWeight() // Weight of tree is weight of root
    { return root.weight(); }

    //returns letter
    public char getLetter()
    { return root.letter(); }

    public HashMap getMap()
    { return map; }

    //copy this from online source?
    //copy buildTree from online source?


    //*******Format for printing***********
    //
    //For character and frequency print out there should be
    //character space integer newline
    //String charFreqTable = new String();
    //char myChar;
    //int myFrequency;
    ////one line of the table would be as follows:
    //charFreqTable = char+" "+myFrequency+"\n";
    //For character and code print out there should be
    //character space String newline
    //String charCodeTable = new String();
    //char myChar;
    //      String myCodeString;  //string of 1s and 0s.
    ////one line of the table would be as follows
    //charCodeTable = char+" "+myCodeString+"\n";
    //*******************

    //read every character and create an array of its frequencies
    //file reader found at http://www.java2s.com/Code/Java/File-Input-Output/Readfilecharacterbycharacter.htm
    public int[] createArray(File inputFile)
    {
        //check that file exists
        if(!inputFile.exists())
        {
            System.out.println("ERROR: Input file does not exist.");
            return null;
        }
        //check that file can be read
        if(!(inputFile.isFile() && inputFile.canRead()))
        {
            System.out.println("ERROR: Input file cannot be read.");
            return null;
        }
        int[] arr = new int[128];       //
        try
        {
            FileInputStream reader = new FileInputStream(inputFile);
            char current;
            while (reader.available() > 0)          //read every character in the file
            {
                current = (char) reader.read();
                if(current != 10 && current !=13)       //ignore new line and carriage returns
                    arr[current]+= 1;
            }
        }
        catch (IOException e)         //catch and print any exceptions
        {
            e.printStackTrace();
        }
        return arr;
    }

    //take a file as input and create a table with characters and frequencies
    //print the characters and frequencies
    public String getFrequencies(File inputFile) throws FileNotFoundException
    {
        FileInputStream fInputStream = new FileInputStream(inputFile);      //throws FileNotFoundException if not there
        int[] freqArr = createArray(inputFile);
        String charFreqTable = new String();
        for(int i=0; i<128; i++)
        {
            if(freqArr[i]!=0)
            {
                charFreqTable+= (char)i+" "+freqArr[i]+"\n";
            }
        }
        return charFreqTable;
    }

    //take a file as input and create a Huffman Tree
    public HuffTree buildTree(File inputFile) throws FileNotFoundException, Exception
    {
        FileInputStream fInputStream = new FileInputStream(inputFile);      //throws some exception if file not there
        HuffTree tmp1, tmp2, tmp3 = null;
        Heap tempHeap = new Heap(createArray(inputFile));           //create the heap based on the inputFile

        while (tempHeap.size() > 1)         // While two or more items left
        {
            tmp1 = tempHeap.removeMin();
            tmp2 = tempHeap.removeMin();
            tmp3 = new HuffTree(tmp1.getRoot(), tmp2.getRoot(), tmp1.getWeight() + tmp2.getWeight());
            tempHeap.insert(tmp3);   // Return new tree to heap
        }
        return tmp3;            // Return the completed HuffTree
    }

    //take a file and a HuffTree and encode the file.
    //output a string of 1's and 0's representing the file
    public String encodeFile(File inputFile, HuffTree huffTree) throws FileNotFoundException
    {
        String output = "";
        System.out.println("In encode\n"+huffTree.traverseHuffmanTree(huffTree));        //create a hashmap for inputted huffTree
        HashMap treeMap = huffTree.getMap();
        System.out.println("TreeMap is\n"+treeMap);
        try
        {
            FileInputStream reader = new FileInputStream(inputFile);
            char current;
            while (reader.available() > 0)          //read every character in the file
            {
                current = (char) reader.read();
                if(current != 10 && current !=13)       //ignore new line and carriage returns
                {
                    output += treeMap.get(current);
                    System.out.println("Map is "+treeMap.get(current));
                }
            }
        }
        catch (IOException e)         //catch normal Exception due to way file is read
        {
            e.printStackTrace();
        }
        return output;
    }

    //take a String and HuffTree and output the decoded words
    public String decodeFile(String code, HuffTree huffTree) throws Exception
    {
        return null;
    }

    //print the characters and their codes
    public String traverseHuffmanTree(HuffTree tree)
    {
        if(tree.root == null)       //null root check
            return null;

        String output = "";

        if(tree.root.left() != null)        //check if there is a left child of the parent
            traverseNode(tree.root.left(), "0");

        if(tree.root.right() != null)           //check if there is a right child of the parent
            traverseNode(tree.root.right(), "1");

        //map output taken from https://stackoverflow.com/questions/1066589/iterate-through-a-hashmap
        Iterator it = map.entrySet().iterator();
        while (it.hasNext()) {
            Map.Entry pair = (Map.Entry)it.next();
            output += pair.getKey()+"  "+pair.getValue()+"\n";
        }
        return output;
    }

    //takes in a node and traverses through all of its children
    private void traverseNode (HuffNode node, String output)
    {
        if( (node.left() == null) && (node.right() == null) )       //if children are null then add left to hashmap
        {
            map.put(node.letter(), output);
            return;
        }

        if(node.left() != null)                     //check left child node
            traverseNode(node.left(), output+"0");

        if(node.right() != null)                    //check right child node
            traverseNode(node.right(), output+"1");
    }
}
